<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diffraction Grating Simulator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and Babel for JSX rendering -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
        }
        /* Custom track colors for range inputs */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #4b5563;
            border-radius: 10px;
        }
        input[type="range"]::-moz-range-track {
            background: #4b5563;
            border-radius: 10px;
        }
        /* Styling for the spectrum gradient background in ScreenSimulation */
        .screen-simulation-container {
            mix-blend-mode: screen; /* Crucial for light addition simulation */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Icon Component (Equivalent to Lucide Icons) ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.41 1.41"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M6.34 17.66l-1.41 1.41"></path><path d="M19.07 4.93l-1.41 1.41"></path></svg>,
                Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
                Info: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>,
                Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size} height={props.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            };
            const TargetIcon = icons[name];
            return TargetIcon ? <TargetIcon size={size} className={className} /> : null;
        };


        const { useState, useMemo } = React;

        const DiffractionGratingApp = () => {
            // State
            const [wavelength, setWavelength] = useState(532); // nm (Green)
            const [linesPerMm, setLinesPerMm] = useState(300); // N
            const [isWhiteLight, setIsWhiteLight] = useState(true);
            const [screenDistance, setScreenDistance] = useState(1.5); // meters (virtual scale)
            
            // Constants
            const visibleRange = { min: 400, max: 700 }; 
            const orders = [0, 1, 2, 3, 4];
            const screenWidthPhysical = 2.0; // meters (assumed screen width for calculation)
            
            // Calculations
            const d = useMemo(() => 1e-3 / linesPerMm, [linesPerMm]); // grating spacing in meters

            // Helper to get color from wavelength
            const getWavelengthColor = (wl) => {
                if (wl < 400) return "rgb(146, 39, 143)"; // Violet
                if (wl >= 400 && wl < 440) return "rgb(146, 39, 143)"; // Violet
                if (wl >= 440 && wl < 490) return "blue";
                if (wl >= 490 && wl < 510) return "cyan";
                if (wl >= 510 && wl < 580) return "rgb(0, 255, 0)"; // Green
                if (wl >= 580 && wl < 645) return "rgb(255, 165, 0)"; // Yellow/Orange
                if (wl >= 645 && wl <= 700) return "red";
                if (wl > 700) return "red";
                return "gray";
            };

            // Calculate diffraction angle and position
            const calculatePosition = (n, wl_nm) => {
                const wl_m = wl_nm * 1e-9;
                const sinTheta = (n * wl_m) / d;
                
                if (Math.abs(sinTheta) > 1) return null;
                
                const theta = Math.asin(sinTheta);
                const y = screenDistance * Math.tan(theta); // distance from center
                
                return {
                    theta: (theta * 180) / Math.PI, // degrees
                    y: y, // meters
                    valid: true
                };
            };

            // --- SVG Components ---

            const RayDiagram = () => {
                const svgWidth = 600;
                const svgHeight = 300;
                const centerX = 50;
                const centerY = 150;
                const screenX = 550;
                
                // Scaling factor to map physical screen width to SVG height
                const scaleY = (svgHeight * 0.9) / screenWidthPhysical; 

                return (
                    <svg width="100%" height="100%" viewBox={`0 0 ${svgWidth} ${svgHeight}`} className="bg-gray-900 border border-gray-700 rounded-lg shadow-inner">
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#fff" />
                            </marker>
                        </defs>

                        {/* Center Line and Grating */}
                        <line x1="0" y1={centerY} x2={svgWidth} y2={centerY} stroke="#333" strokeDasharray="5,5" />
                        <line x1="0" y1={centerY} x2={centerX} y2={centerY} stroke={isWhiteLight ? "white" : getWavelengthColor(wavelength)} strokeWidth="4" />
                        <line x1={centerX} y1={centerY - 40} x2={centerX} y2={centerY + 40} stroke="#888" strokeWidth="4" strokeDasharray="4,2" />
                        <text x={centerX - 10} y={centerY - 50} fill="#aaa" fontSize="12">Grating ({linesPerMm} lines/mm)</text>
                        
                        {/* Screen */}
                        <line x1={screenX} y1="10" x2={screenX} y2={svgHeight - 10} stroke="#555" strokeWidth="6" />
                        <text x={screenX - 20} y="20" fill="#aaa" fontSize="12" textAnchor="end">Screen</text>

                        {orders.map(n => {
                            if (n === 0) {
                                return (
                                    <g key="n0">
                                        <line x1={centerX} y1={centerY} x2={screenX} y2={centerY} 
                                            stroke={isWhiteLight ? "white" : getWavelengthColor(wavelength)} 
                                            strokeWidth="2" opacity="0.8" />
                                        <text x={screenX + 6} y={centerY + 3} fill="#9ca3af" fontSize="10" fontWeight="normal">n=0</text>
                                    </g>
                                );
                            }

                            let rays = [];
                            if (isWhiteLight) {
                                // Red and Violet rays to show the spectrum spread
                                rays = [
                                    { wl: visibleRange.min, color: getWavelengthColor(visibleRange.min) },
                                    { wl: visibleRange.max, color: getWavelengthColor(visibleRange.max) }
                                ];
                            } else {
                                // Single color ray
                                rays = [{ wl: wavelength, color: getWavelengthColor(wavelength) }];
                            }

                            // Calculate label position (using average wavelength for better placement in white light)
                            const labelWl = isWhiteLight ? (visibleRange.min + visibleRange.max) / 2 : wavelength;
                            const labelData = calculatePosition(n, labelWl);
                            
                            let labelElement = null;
                            if (labelData && labelData.valid) {
                                const yOff = labelData.y * scaleY;
                                const topY = centerY - yOff;
                                const botY = centerY + yOff;
                                
                                // Only draw label if visible within SVG height
                                const margin = 5;
                                const isTopVisible = topY > margin && topY < svgHeight - margin;
                                const isBotVisible = botY > margin && botY < svgHeight - margin;

                                // Draw the order label (n=X) next to the screen
                                labelElement = (
                                    <>
                                        {isTopVisible && <text x={screenX + 6} y={topY + 3} fill="#9ca3af" fontSize="10">n={n}</text>}
                                        {isBotVisible && <text x={screenX + 6} y={botY + 3} fill="#9ca3af" fontSize="10">n={n}</text>}
                                    </>
                                );
                            }

                            return (
                                <g key={`order-group-${n}`}>
                                    {rays.map((ray, idx) => {
                                        const data = calculatePosition(n, ray.wl);
                                        if (!data || !data.valid) return null;
                                        
                                        const targetY_top = centerY - (data.y * scaleY);
                                        const targetY_bot = centerY + (data.y * scaleY);

                                        if (targetY_top < 0 || targetY_bot > svgHeight) return null;

                                        return (
                                            <g key={`ray-${n}-${idx}`}>
                                                {/* Upper ray (e.g. n=+1) */}
                                                <line x1={centerX} y1={centerY} x2={screenX} y2={targetY_top} stroke={ray.color} strokeWidth="1.5" opacity="0.6" />
                                                {/* Lower ray (e.g. n=-1) */}
                                                <line x1={centerX} y1={centerY} x2={screenX} y2={targetY_bot} stroke={ray.color} strokeWidth="1.5" opacity="0.6" />
                                            </g>
                                        );
                                    })}
                                    {labelElement}
                                </g>
                            );
                        })}
                    </svg>
                );
            };

            const ScreenSimulation = () => {
                const metersToPercent = (m) => (m / screenWidthPhysical) * 100;

                return (
                    <div className="relative w-full h-32 bg-black border-t-4 border-b-4 border-gray-800 rounded overflow-hidden shadow-[0_0_20px_rgba(0,0,0,1)_inset]">
                        {/* n=0 center fringe */}
                        <div className="absolute top-0 bottom-0 w-1 blur-[2px]" 
                             style={{ 
                                left: '50%', 
                                transform: 'translateX(-50%)', 
                                opacity: 1, 
                                boxShadow: isWhiteLight ? '0 0 10px white' : `0 0 10px ${getWavelengthColor(wavelength)}`, 
                                background: isWhiteLight ? 'white' : getWavelengthColor(wavelength) 
                             }}
                        ></div>
                        <div className="absolute bottom-1 left-1/2 -translate-x-1/2 text-[10px] text-gray-400">n=0</div>

                        {orders.filter(n => n > 0).map(n => {
                            let startPos = null;
                            let endPos = null;
                            let singlePos = null;

                            if (isWhiteLight) {
                                // Calculate position for violet (min WL) and red (max WL)
                                const violet = calculatePosition(n, visibleRange.min);
                                const red = calculatePosition(n, visibleRange.max); 
                                if (violet && red) {
                                    startPos = metersToPercent(violet.y); // Violet is inner edge
                                    endPos = metersToPercent(red.y);     // Red is outer edge
                                }
                            } else {
                                // Calculate position for monochromatic light
                                const p = calculatePosition(n, wavelength);
                                if (p) singlePos = metersToPercent(p.y);
                            }

                            const renderFringe = (positionPct, sideMultiplier) => {
                                const leftPos = 50 + (positionPct * sideMultiplier);
                                if (leftPos < -10 || leftPos > 110) return null;

                                return (
                                    <div key={`fringe-${n}-${sideMultiplier}`} 
                                        className="absolute top-0 bottom-0"
                                        style={{ left: `${leftPos}%` }}>
                                        
                                        {!isWhiteLight && (
                                            <div className="w-1 h-full blur-[2px]" 
                                                style={{ 
                                                backgroundColor: getWavelengthColor(wavelength),
                                                boxShadow: `0 0 ${8 - n}px ${getWavelengthColor(wavelength)}`,
                                                opacity: Math.max(0.2, 1 - n * 0.15), 
                                                transform: 'translateX(-50%)'
                                                }} />
                                        )}
                                    </div>
                                );
                            };

                            if (isWhiteLight && startPos !== null && endPos !== null) {
                                const width = endPos - startPos;
                                
                                const rightStart = 50 + startPos; // Right side (Violet edge)
                                const leftStart = 50 - endPos; // Left side (Red edge)
                                
                                return (
                                    <React.Fragment key={`order-${n}`}>
                                        {/* Right Spectrum */}
                                        {rightStart < 100 && (
                                            <>
                                                <div className="absolute top-0 bottom-0 screen-simulation-container"
                                                    style={{
                                                        left: `${rightStart}%`,
                                                        width: `${width}%`,
                                                        // Spectrum gradient from Violet to Red (left to right)
                                                        background: 'linear-gradient(to right, #4b0082, blue, green, yellow, red)',
                                                        opacity: Math.max(0.5, 1 - n * 0.1)
                                                    }}>
                                                </div>
                                                <div className="absolute bottom-8 text-[10px] text-gray-400 border-l border-gray-600 pl-1" style={{ left: `${rightStart + width/2}%` }}>
                                                    n={n}
                                                </div>
                                            </>
                                        )}

                                        {/* Left Spectrum */}
                                        {leftStart + width > 0 && (
                                            <>
                                                <div className="absolute top-0 bottom-0 screen-simulation-container"
                                                    style={{
                                                        left: `${leftStart}%`,
                                                        width: `${width}%`,
                                                        // Spectrum gradient from Red to Violet (left to right)
                                                        background: 'linear-gradient(to right, red, yellow, green, blue, #4b0082)',
                                                        opacity: Math.max(0.5, 1 - n * 0.1)
                                                    }}>
                                                </div>
                                                <div className="absolute bottom-8 text-[10px] text-gray-400 border-r border-gray-600 pr-1 text-right" style={{ left: `${leftStart + width/2}%` }}>
                                                    n={n}
                                                </div>
                                            </>
                                        )}
                                    </React.Fragment>
                                );
                            } else if (!isWhiteLight && singlePos) {
                                // Monochromatic light fringes
                                return (
                                    <React.Fragment key={`order-${n}`}>
                                        {renderFringe(singlePos, 1)}
                                        {renderFringe(singlePos, -1)}
                                        <div className="absolute bottom-1 text-[10px] text-gray-500" style={{left: `${50 + singlePos}%`, transform:'translateX(-50%)'}}>n={n}</div>
                                        <div className="absolute bottom-1 text-[10px] text-gray-500" style={{left: `${50 - singlePos}%`, transform:'translateX(-50%)'}}>n={n}</div>
                                    </React.Fragment>
                                )
                            }
                            return null;
                        })}

                        {/* Grid overlay */}
                        <div className="absolute inset-0 pointer-events-none bg-[linear-gradient(90deg,rgba(255,255,255,0.05)_1px,transparent_1px)] bg-[size:5%_100%]"></div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col w-full max-w-5xl mx-auto p-4 bg-gray-950 text-gray-100 rounded-xl shadow-2xl font-sans min-h-screen">
                    <header className="mb-6 border-b border-gray-800 pb-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-400 flex items-center gap-2">
                                <Icon name="Sun" className="w-6 h-6" /> 
                                Diffraction Grating Simulator
                            </h1>
                            <p className="text-sm text-gray-400 mt-1">
                                Formula: <code className="bg-gray-900 px-1 py-0.5 rounded text-yellow-300">d sin θ = n λ</code>
                            </p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 flex flex-col gap-6">
                            {/* Control Panel */}
                            <div className="bg-gray-900 p-5 rounded-lg border border-gray-800 flex flex-col gap-6">
                                <div className="flex flex-col gap-2">
                                    <label className="text-sm font-semibold text-gray-300 flex items-center gap-2">
                                        <Icon name="Zap" size={16} /> Light Source
                                    </label>
                                    <div className="flex bg-gray-800 p-1 rounded-lg">
                                        <button 
                                            onClick={() => setIsWhiteLight(true)}
                                            className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${isWhiteLight ? 'bg-gradient-to-r from-purple-500 via-green-500 to-red-500 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}
                                        >
                                            White Light
                                        </button>
                                        <button 
                                            onClick={() => setIsWhiteLight(false)}
                                            className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${!isWhiteLight ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}
                                        >
                                            Monochromatic
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between mb-1">
                                            <label className="text-xs text-gray-400">Grating Density (Lines/mm)</label>
                                            <span className="text-xs font-mono text-blue-300">{linesPerMm} lines/mm</span>
                                        </div>
                                        <input 
                                            type="range" min="100" max="1000" step="10" 
                                            value={linesPerMm} onChange={(e) => setLinesPerMm(Number(e.target.value))}
                                            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                        />
                                        <div className="text-[10px] text-gray-500 mt-1">d = {(1000/linesPerMm).toFixed(2)} μm</div>
                                    </div>

                                    {!isWhiteLight && (
                                        <div>
                                           <div className="flex justify-between mb-1">
                                            <label className="text-xs text-gray-400">Wavelength (λ)</label>
                                            <span className="text-xs font-mono" style={{color: getWavelengthColor(wavelength)}}>{wavelength} nm</span>
                                          </div>
                                          <input 
                                            type="range" min="400" max="700" step="1" 
                                            value={wavelength} onChange={(e) => setWavelength(Number(e.target.value))}
                                            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-400"
                                            style={{ accentColor: getWavelengthColor(wavelength) }}
                                          />
                                        </div>
                                    )}

                                    <div>
                                         <div className="flex justify-between mb-1">
                                            <label className="text-xs text-gray-400">Screen Distance (L)</label>
                                            <span className="text-xs font-mono text-blue-300">{screenDistance.toFixed(1)} m</span>
                                          </div>
                                          <input 
                                            type="range" min="0.5" max="5.0" step="0.1" 
                                            value={screenDistance} onChange={(e) => setScreenDistance(Number(e.target.value))}
                                            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                          />
                                    </div>
                                </div>
                                
                                 <div className="bg-purple-900/20 border border-purple-800 p-3 rounded text-[10px] text-purple-200 mt-2">
                                    <Icon name="Info" size={12} className="inline mr-1" />
                                    Note: Overlap occurs when the red end of the n=2 spectrum meets the violet end of the n=3 spectrum. This is a real physical phenomenon.
                                 </div>
                            </div>
                        </div>

                        {/* Simulation View */}
                        <div className="lg:col-span-2 flex flex-col gap-4">
                            <div className="bg-gray-800 p-1 rounded-lg border border-gray-700 relative group">
                                <div className="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-gray-300">Ray Diagram (Top View)</div>
                                <div className="h-64 w-full">
                                    <RayDiagram />
                                </div>
                            </div>

                            <div className="bg-gray-800 p-1 rounded-lg border border-gray-700 relative">
                                <div className="flex items-center justify-between mb-2 px-2 pt-1">
                                    <div className="text-xs font-semibold text-gray-300 flex items-center gap-2">
                                        <Icon name="Eye" size={14} /> Screen View
                                    </div>
                                    <div className="text-[10px] text-gray-500">Center (n=0)</div>
                                </div>
                                <ScreenSimulation />
                                <div className="mt-2 px-2 flex justify-between text-[10px] text-gray-500">
                                <span>Left Side</span>
                                <span>Right Side</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the application
        ReactDOM.render(<DiffractionGratingApp />, document.getElementById('root'));
    </script>
</body>
</html>
